name: Windows Build (VS2017 Toolset)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: windows-2019
    defaults:
      run:
        working-directory: source

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate CMakeLists.txt
      shell: pwsh
      run: |
        # 1. 设置工作区路径变量
        $dataPath = "${env:GITHUB_WORKSPACE}/data"
        
        # 【关键修复】：将所有反斜杠替换为正斜杠
        # 避免 CMake 解析错误 "Invalid character escape '\a'"
        $dataPath = $dataPath.Replace('\', '/')

        # 2. 生成文件
        'cmake_minimum_required(VERSION 3.15)' | Out-File -Encoding utf8 "CMakeLists.txt"
        'project(CloudyBuild CXX)' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'set(CMAKE_CXX_STANDARD 11)' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'file(GLOB_RECURSE ALL_SOURCES "*.cpp")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "Test.*\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "md5datafile\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "cloudy_lua\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'add_executable(cloudy.exe ${ALL_SOURCES})' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'if(NOT EXISTS "cloudyconfig.h")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  file(WRITE "cloudyconfig.h" "// Auto-generated by GitHub Actions")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'endif()' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 这里使用了已经转换为正斜杠的变量
        "target_compile_definitions(cloudy.exe PRIVATE \`"SYS_CONFIG=\`"cloudyconfig.h\`" \`"CLOUDY_DATA_PATH=$dataPath\`")" | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'target_compile_options(cloudy.exe PRIVATE' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /O2      # 最大化速度' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /Ob1     # 内联函数扩展' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /MP      # 多核编译' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4244  # 类型转换警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4305  # 截断警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4996  # 安全函数警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4838  # 类型转换警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /Zi      # 生成调试信息' | Add-Content -Encoding utf8 "CMakeLists.txt"
        ')' | Add-Content -Encoding utf8 "CMakeLists.txt"

    # 使用 VS2019 生成器 + VS2017 工具集
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 16 2019" -A x64 -T v141

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudy-win-vs2017
        path: source/build/Release/cloudy.exe
