name: Windows Build (VS2017)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: windows-2019
    defaults:
      run:
        working-directory: source

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate CMakeLists.txt
      shell: pwsh
      run: |
        # 1. 设置工作区路径变量
        $dataPath = "${env:GITHUB_WORKSPACE}/data"

        # 2. 使用逐行覆写的方式生成 CMakeLists.txt
        #    使用单引号 '...' 可以让所有内容原样写入，不需要转义符号
        
        'cmake_minimum_required(VERSION 3.15)' | Out-File -Encoding utf8 "CMakeLists.txt"
        'project(CloudyBuild CXX)' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        'set(CMAKE_CXX_STANDARD 11)' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 收集源文件
        'file(GLOB_RECURSE ALL_SOURCES "*.cpp")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 排除文件 (注意：单引号下不需要转义 )
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "Test.*\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "md5datafile\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'list(FILTER ALL_SOURCES EXCLUDE REGEX "cloudy_lua\.cpp$")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 定义可执行文件
        # 这里的 ${ALL_SOURCES} 会被原样写入，不会被 PowerShell 解析
        'add_executable(cloudy.exe ${ALL_SOURCES})' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 处理配置头文件
        'if(NOT EXISTS "cloudyconfig.h")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  file(WRITE "cloudyconfig.h" "// Auto-generated by GitHub Actions")' | Add-Content -Encoding utf8 "CMakeLists.txt"
        'endif()' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 设置编译宏定义
        # 这行需要动态路径，所以使用双引号 "..."
        # 注意 CMake 文件内部需要引号，所以这里用 `\"` 转义
        "target_compile_definitions(cloudy.exe PRIVATE \`"SYS_CONFIG=\`"cloudyconfig.h\`" \`"CLOUDY_DATA_PATH=$dataPath\`")" | Add-Content -Encoding utf8 "CMakeLists.txt"
        '' | Add-Content -Encoding utf8 "CMakeLists.txt"
        
        # 设置编译选项
        'target_compile_options(cloudy.exe PRIVATE' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /O2      # 最大化速度' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /Ob1     # 内联函数扩展' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /MP      # 多核编译' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4244  # 类型转换警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4305  # 截断警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4996  # 安全函数警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /wd4838  # 类型转换警告' | Add-Content -Encoding utf8 "CMakeLists.txt"
        '  /Zi      # 生成调试信息' | Add-Content -Encoding utf8 "CMakeLists.txt"
        ')' | Add-Content -Encoding utf8 "CMakeLists.txt"

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 15 2017" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudy-win-vs2017
        path: source/build/Release/cloudy.exe
