name: Windows Build (VS2017)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: windows-2019
    defaults:
      run:
        working-directory: source

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate CMakeLists.txt
      shell: pwsh
      run: |
        # 定义路径，将路径统一转换为正斜杠格式，避免 CMake 解析错误
        $dataPath = "${env:GITHUB_WORKSPACE}/data"
        
        # 构建文件内容列表（避免在大字符串中转义出错）
        $cmakeContent = @(
          "cmake_minimum_required(VERSION 3.15)",
          "project(CloudyBuild CXX)",
          "",
          "set(CMAKE_CXX_STANDARD 11)",
          "",
          "# 收集所有源文件",
          "file(GLOB_RECURSE ALL_SOURCES `"*.cpp`")",
          "",
          "# 排除特定文件 (模拟 Makefile 逻辑)",
          "list(FILTER ALL_SOURCES EXCLUDE REGEX `"Test.*\\.cpp`$`")",
          "list(FILTER ALL_SOURCES EXCLUDE REGEX `"md5datafile\\.cpp`$`")",
          "list(FILTER ALL_SOURCES EXCLUDE REGEX `"cloudy_lua\\.cpp`$`")",
          "",
          "# 构建主程序",
          "# 注意：这里必须写 `$('{ALL_SOURCES}')` 让 PowerShell 输出字面量 `${ALL_SOURCES}`",
          "add_executable(cloudy.exe `$('{ALL_SOURCES}')`)",
          "",
          "# 生成配置头文件占位符",
          "if(NOT EXISTS `"cloudyconfig.h`")",
          "  file(WRITE `"cloudyconfig.h`" `"// Auto-generated by GitHub Actions`")",
          "endif()",
          "",
          "# 定义宏参数 (SYS_CONFIG 必须包含值，否则有些编译器会报错)",
          "target_compile_definitions(cloudy.exe PRIVATE",
          "  SYS_CONFIG=`"cloudyconfig.h`"",
          "  `"CLOUDY_DATA_PATH=$dataPath`"",
          ")",
          "",
          "# 设置编译选项 (VS2017 / MSVC)",
          "target_compile_options(cloudy.exe PRIVATE",
          "  /O2      # 最大化速度",
          "  /Ob1     # 内联函数扩展",
          "  /MP      # 多核编译",
          "  /wd4244  # 类型转换警告",
          "  /wd4305  #截断警告",
          "  /wd4996  #安全函数警告",
          "  /wd4838  #类型转换警告",
          "  /Zi      # 生成调试信息",
          ")"
        )
        
        # 将内容写入文件，使用 UTF8 编码
        $cmakeContent | Out-File -FilePath "CMakeLists.txt" -Encoding utf8
        Write-Host "CMakeLists.txt generated successfully."

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 15 2017" -A x64

    - name: Build
      run: cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudy-win-vs2017
        path: source/build/Release/cloudy.exe
