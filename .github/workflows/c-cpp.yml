name: Windows Build (VS2017)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: windows-2019  # 包含 VS2017 环境
    defaults:
      run:
        working-directory: source  # 指定工作目录为 source

    steps:
    # 1. 检出代码
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # 获取完整历史，以防代码需要版本号

    # 2. 准备构建环境
    # 由于无法直接运行 Unix Makefile，我们生成一个 CMakeLists.txt 来替代它
    - name: Generate CMakeLists.txt for VS2017
      shell: pwsh
      run: |
        $cmakeContent = @"
        cmake_minimum_required(VERSION 3.15)
        project(CloudyBuild CXX)
        
        # 设置 C++ 标准
        set(CMAKE_CXX_STANDARD 11)
        
        # 模拟 Makefile 的文件收集 (GLOB_RECURSE)
        file(GLOB_RECURSE ALL_SOURCES "/*.cpp")
        
        # 模拟 Makefile 中的文件排除逻辑
        # 1. 排除 Test 开头的文件 (Makefile: filter-out Test%)
        # 2. 排除 md5datafile.cpp (Prompt 1 要求)
        # 3. 排除 cloudy_lua.cpp (Prompt 1 要求)
        list(FILTER ALL_SOURCES EXCLUDE REGEX "Test.*\\.cpp$")
        list(FILTER ALL_SOURCES EXCLUDE REGEX "md5datafile\\.cpp$")
        list(FILTER ALL_SOURCES EXCLUDE REGEX "cloudy_lua\\.cpp$")
        
        # 创建可执行文件
        add_executable(cloudy.exe `\${ALL_SOURCES})
        
        # 模拟 configure.sh，生成一个空的 cloudyconfig.h 防止编译报错
        # Makefile 中定义了 SYS_CONFIG，我们需要确保这个宏有效
        if(NOT EXISTS "`${CMAKE_CURRENT_SOURCE_DIR}/cloudyconfig.h")
            file(WRITE "`${CMAKE_CURRENT_SOURCE_DIR}/cloudyconfig.h" 
            "// Auto-generated by GitHub Actions\n#ifndef CLOUDY_CONFIG_H\n#define CLOUDY_CONFIG_H\n#define SYS_CONFIG 1\n#endif")
        endif()
        
        # 设置预处理器定义
        # CLOUDY_DATA_PATH: 设置为仓库中的 data 目录
        # SYS_CONFIG: 指向生成的头文件
        target_compile_definitions(cloudy.exe PRIVATE 
            SYS_CONFIG="cloudyconfig.h"
            CLOUDY_DATA_PATH="`"${env:GITHUB_WORKSPACE}/data`""
        )

        # 设置编译选项 (对标 Makefile 中的 OPT=-O3)
        # /O2: Windows 下对应最大化速度
        # /Ob1: 对应 Makefile 中的 inline function expansion 逻辑
        # /MP: 多核编译
        # /wd...: 禁用特定的警告 (Prompt 1 中要求的 4244; 4305; 4996; 4838)
        target_compile_options(cloudy.exe PRIVATE 
            /O2      
            /Ob1     
            /MP      
            /wd4244  
            /wd4305  
            /wd4996  
            /wd4838  
            /Zi      # 生成调试信息
        )
        
        # 设置运行时库选项 (Release 模式下通常对应 /MD 或 /MT，这里使用默认)
        "@
        
        # 将写入 CMakeLists.txt
        Set-Content -Path "CMakeLists.txt" -Value $cmakeContent -Encoding UTF8
        Write-Host "CMakeLists.txt generated successfully."

    # 3. 配置 CMake 生成 VS2017 解决方案
    # -G "Visual Studio 15 2017" 指定使用 VS2017
    - name: Configure CMake (VS2017)
      run: cmake -B build -G "Visual Studio 15 2017" -A x64

    # 4. 编译项目
    - name: Build
      run: cmake --build build --config Release

    # 5. 上传产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: cloudy-win-vs2017
        path: source/build/Release/cloudy.exe
